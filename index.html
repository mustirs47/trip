<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Travel Expenses — Management & Export</title>
<style>
:root{
  font-family:'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  --gap:12px;
  --border-radius:10px;
  --shadow:0 8px 28px rgba(12,20,40,.06);
  --primary:#0f62fe;
  --primary-dark:#0a4bd8;
  --muted:#f1f4ff;
  --muted-border:#d7def0;
  --muted-headers:#e9ecef; /* header slightly darker */
  --danger:#ff3b3b; /* vivid red */
  --text:#111;
  --bg:#f5f7fb;
  --card-bg:#fff;
  --input-bg:#fff;
  --input-border:#dde3f0;
  --table-border:#c8d2e6;
  --row-hover:#f5f7fb;
  --warning:#ffdddd;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  :root{
    --primary:#7aa2ff;
    --primary-dark:#598dff;
    --muted:#0f1720;
    --muted-border:#203147;
    --muted-headers:#0f1a26;
    --danger:#ff6b6b;
    --text:#e6eef8;
    --bg:#0b1220;
    --card-bg:#08101a;
    --input-bg:#08141f;
    --input-border:#183047;
    --table-border:#183047;
    --row-hover:#071824;
    --warning:#5a1b1b;
  }
}

*{box-sizing:border-box}
body{margin:0;padding:20px;background:var(--bg);color:var(--text);-webkit-text-size-adjust:100%;}
.card{max-width:1100px;margin:0 auto;background:var(--card-bg);padding:24px;border-radius:var(--border-radius);box-shadow:var(--shadow);}
h1{font-size:22px;margin-bottom:16px}

/* header inputs layout */
.row{display:flex;gap:var(--gap);flex-wrap:wrap}
.field{flex:1 1 220px;min-width:160px}
label{display:block;font-size:13px;margin-bottom:6px;font-weight:500;color:var(--text)}

/* unified input design */
input[type=text], input[type=number], input[type=date], input[list], textarea{
  width:100%;
  height:44px;
  padding:10px 12px;
  font-size:14px;
  border-radius:8px;
  border:1px solid var(--input-border);
  background:var(--input-bg);
  color:var(--text);
  -webkit-appearance:none;
  appearance:none;
  outline:none;
  line-height:1.2;
  box-sizing:border-box;
}

/* remove spinners */
input[type=number]{-moz-appearance:textfield}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

/* iOS autofill neutralization */
input:-webkit-autofill,input:-webkit-autofill:hover,input:-webkit-autofill:focus,textarea:-webkit-autofill,select:-webkit-autofill{
  -webkit-text-fill-color:var(--text)!important;
  -webkit-box-shadow:0 0 0px 1000px var(--input-bg) inset!important;
  box-shadow:0 0 0px 1000px var(--input-bg) inset!important;
  border:1px solid var(--input-border)!important;
}

/* date: keep same height and ensure full value fits */
input[type="date"]::-webkit-calendar-picker-indicator{opacity:0;display:block;width:18px;height:18px}
input[type="date"]{
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='%23666'><path d='M7 10h5v5H7z' opacity='.0001'/><path d='M7 2v2H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-2V2h-2v2H9V2H7zm14 8H3v8h18v-8z'/></svg>");
  background-repeat:no-repeat;
  background-position:right 12px center;
  background-size:18px;
  padding-right:12px; /* keep tight so entire date text fits */
  /* ensure left padding enough and avoid clipping final digit */
  color:var(--text);
}

/* select replacement uses datalist + input; style datalist-input same as input (list uses input[type=text]) */

/* focus */
input:focus, select:focus, textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(15,98,254,0.12)}

/* Buttons */
.actions{display:flex;gap:var(--gap);margin-top:16px;flex-wrap:wrap}
button{padding:10px 16px;font-size:14px;border-radius:8px;cursor:pointer;border:0;transition:all .12s}
button:hover{opacity:0.96}
.primary{background:var(--primary-dark);color:#fff;font-weight:600}
.muted{background:#fff;color:#000;border:1px solid #cfcfcf} /* CSV white background, black text */
.muted:hover{filter:brightness(.98)}
.danger{background:var(--danger);color:#fff;font-weight:700}
button[disabled]{opacity:0.6;cursor:not-allowed}

/* Warning banner above table when SheetJS blocked */
.export-warning{
  display:none;
  background:var(--warning);
  color:var(--text);
  border:1px solid rgba(255,0,0,0.08);
  padding:10px 12px;
  border-radius:6px;
  margin-bottom:12px;
  font-weight:600;
}

/* Table wrapper with outer border */
.table-wrapper{
  margin-top:16px;
  overflow-x:auto;
  border:1px solid var(--table-border);
  border-radius:8px;
  background:var(--card-bg);
}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  table-layout:auto; /* allow columns to size to content so table not wider than necessary */
  color:var(--text);
  min-width:0; /* prevent unnecessary expansion */
}
colgroup col{vertical-align:middle}
col.num{width:60px} col.date{width:160px} col.cat{width:220px} col.curr{width:100px} col.rate{width:110px} col.cost{width:130px}

/* header & cells */
th, td{padding:10px 12px;text-align:left;vertical-align:middle;border-bottom:1px solid rgba(0,0,0,0.04);font-size:14px}
th{background:var(--muted-headers);font-weight:700;color:var(--text);border-bottom:1px solid var(--table-border)}
.numcol{text-align:center;font-weight:700}
tbody tr:hover{background:var(--row-hover);transition:0.12s}

/* inputs inside table - ensure date input has full width so last char not cut */
tbody input[type="date"], tbody input[type="text"], tbody input[type="number"]{
  height:40px;padding:8px 10px;font-size:14px;border-radius:6px;border:1px solid var(--input-border);width:100%;box-sizing:border-box;background:var(--input-bg)
}
.r-curr,.r-rate,.r-cost{min-width:70px;max-width:220px}

/* ensure table not unnecessarily wider than content on desktop */
.table-wrapper::-webkit-scrollbar{height:10px}
.table-wrapper{max-width:100%}

/* Total container outside table and always visible */
.total-container{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:16px;
  margin-top:12px;
  font-size:16px;
  margin-bottom:8px;
}
.total-label{font-weight:700}
.total-value{font-weight:700}

/* Powered by Ovarna line */
.powered{
  margin-top:8px;
  text-align:center;
  font-size:14px;
  color:var(--text);
  font-weight:600;
}
.powered a{ color:var(--text); text-decoration:none; font-weight:700; margin-right:8px; }
.powered a.email{ font-weight:500; text-decoration:underline; }

/* footer */
.footer{margin-top:6px;font-size:12px;text-align:center;color:#999}

/* responsive */
@media(max-width:768px){
  .field{flex:1 1 140px}
  col.date{width:140px}
}
</style>
</head>
<body>
<div class="card">
  <h1>Travel Expenses — Management & Export</h1>

  <div class="row">
    <div class="field"><label for="arrival">Arrival Date</label><input id="arrival" type="date" autocomplete="off"></div>
    <div class="field"><label for="return">Return Date</label><input id="return" type="date" autocomplete="off"></div>
    <div class="field"><label for="traveler">Traveler</label><input id="traveler" type="text" placeholder="Name" autocomplete="name"></div>
  </div>

  <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
    <div class="small">Receipts: <span class="count" id="row-count">0</span></div>
    <div style="display:flex;gap:12px">
      <button id="add-row" class="primary">Add Row +</button>
      <button id="remove-row" class="muted">Remove Last -</button>
    </div>
  </div>

  <!-- export warning placeholder (hidden unless SheetJS blocked) -->
  <div id="export-warning" class="export-warning" role="alert">
    Excel export blocked: A content or ad blocker is preventing the export library from loading. Disable the blocker or use the CSV export function.
  </div>

  <!-- Table area with outer border -->
  <div class="table-wrapper" id="table-wrapper">
    <table id="receipts-table" role="table" aria-label="Receipts">
      <colgroup>
        <col class="num"><col class="date"><col class="cat"><col class="curr"><col class="rate"><col class="cost"><col>
      </colgroup>
      <thead>
        <tr>
          <th class="numcol">No</th>
          <th>Date</th>
          <th>Category</th>
          <th>Currency</th>
          <th>Exchange Rate</th>
          <th>Cost in EUR</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Total row outside horizontally scrolling table -->
  <div id="category-totals" style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;margin-top:8px;"></div>
  <div class="total-container" aria-hidden="false">
    <div class="total-label">Total</div>
    <div class="total-value" id="total-cost">0.00</div>
  </div>

  <div class="actions" style="margin-top:12px">
    <button id="download-xlsx" class="primary">Download Excel</button>
    <button id="download-csv" class="muted">Download CSV</button>
    <button id="clear-all" class="danger">Clear All</button>
  </div>
</div>

  <!-- Powered by Ovarna + email -->
  <div class="powered">
    <a id="ovarna-link" href="https://www.ovarna.de/" target="_blank" rel="noopener">Powered by <u>Ovarna</a></u>
    <a class="text" >-</a>
    <a id="ovarna-mail" class="email" href="mailto:info@ovarna.de">info@ovarna.de</a>
  <div class="footer">Version 1.0.9
  </div><br>
  <div class="footer">last changes: The formatting of the “Exchange Rate” number has been adjusted,<br>so that the export always shows a number with 3 decimal places.</div>
  </div>

<!-- Category datalist (keeps selection but allows custom input) -->
<datalist id="cat-list">
  <option value="Food and Drinks"></option>
  <option value="Car"></option>
  <option value="Fuel"></option>
  <option value="Hotel"></option>
</datalist>

<script>
/* Core variables and refs */
const tbody = document.getElementById('tbody');
const rowCountEl = document.getElementById('row-count');
const totalCostEl = document.getElementById('total-cost');
const exportWarning = document.getElementById('export-warning');
const btnXlsx = document.getElementById('download-xlsx');
let rows = [];
let sheetjsAvailable = false;

/* Utilities */
function escapeHtml(unsafe){ return String(unsafe).replace(/[&<"'>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function numericFromInput(v){ const n = parseFloat(String(v||'').replace(',', '.')); return isNaN(n)?0:n; }
function updateTotal(){
  const sum = Array.from(tbody.children).reduce(
    (acc,tr)=> acc + numericFromInput(tr.querySelector('.r-cost').value), 0
  );
  totalCostEl.textContent = sum.toFixed(2);
  updateCategoryTotals();
}

function updateCategoryTotals(){
  const container = document.getElementById('category-totals');
  container.innerHTML = '';

  const sums = {};

  Array.from(tbody.children).forEach(tr=>{
    const cat = tr.querySelector('.r-cat').value.trim();
    const cost = numericFromInput(tr.querySelector('.r-cost').value);
    if(!cat || cost === 0) return;
    sums[cat] = (sums[cat] || 0) + cost;
  });

  Object.entries(sums).forEach(([cat, sum])=>{
    const row = document.createElement('div');
    row.style.fontSize = '14px';
    row.style.fontWeight = '600';
    row.textContent = `${cat}: ${sum.toFixed(2)} €`;
    container.appendChild(row);
  });
}


/* ISO week number for filename Week## */
function getISOWeekNumber(date){
  // date may be string YYYY-MM-DD or Date
  const d = (typeof date === 'string' && date) ? new Date(date) : (date instanceof Date ? date : new Date());
  if(isNaN(d)) return getISOWeekNumber(new Date());
  const target = new Date(d.valueOf());
  const dayNr = (d.getDay() + 6) % 7;
  target.setDate(target.getDate() - dayNr + 3);
  const firstThursday = new Date(target.getFullYear(),0,4);
  const diff = target - firstThursday;
  return 1 + Math.round(diff /  (7 * 24 * 60 * 60 * 1000));
}
function weekFileName(){
  const arrival = document.getElementById('arrival').value;
  const baseDate = arrival || new Date().toISOString().slice(0,10);
  const wk = getISOWeekNumber(baseDate);
  return `Week${wk}`;
}

/* create row - uses datalist for category (input with list) */
function makeRow(data = {}){
  const tr = document.createElement('tr');
  const idx = rows.length + 1;
  const dateVal = data.date || '';
  const currencyVal = data.currency || 'EUR';
  const rateVal = (typeof data.exchangeRate !== 'undefined' ? data.exchangeRate : 1);
  const costVal = (typeof data.cost !== 'undefined' ? data.cost : '');

  tr.innerHTML = `
    <td class="numcol">${idx}</td>
    <td><input type="date" class="r-date" value="${dateVal}" autocomplete="off"></td>
    <td><input type="text" class="r-cat" list="cat-list" value="${escapeHtml(data.category||'Food and Drinks')}"></td>
    <td><input type="text" class="r-curr" value="${escapeHtml(currencyVal)}" autocomplete="off"></td>
    <td><input type="number" class="r-rate" value="${rateVal}" step="0.0001" autocomplete="off"></td>
    <td><input type="number" class="r-cost" value="${costVal}" step="0.01" min="0" autocomplete="off"></td>
    <td><button class="remove-this" title="Remove row">✖</button></td>
  `;

  // Remove handler
  tr.querySelector('.remove-this').addEventListener('click', ()=>{
    const index = rows.indexOf(tr);
    if(index > -1) rows.splice(index,1);
    tr.remove();
    reindex();
    updateTotal();
  });

  // Format cost on blur to 2 decimals
  const costInput = tr.querySelector('.r-cost');
  costInput.addEventListener('blur', ()=> {
    const n = numericFromInput(costInput.value);
    costInput.value = n === 0 && costInput.value === '' ? '' : n.toFixed(2);
    updateTotal();
  });
  costInput.addEventListener('input', updateTotal);

  // Format exchange rate on blur (max 4 decimals, remove trailing commas)
  const rateInput = tr.querySelector('.r-rate');
  rateInput.addEventListener('blur', ()=>{
    let v = String(rateInput.value || '').replace(',', '.').trim();
    const num = parseFloat(v);
    rateInput.value = isNaN(num)? '' : (Math.round(num * 10000) / 10000).toString();
  });

  rows.push(tr);
  tbody.appendChild(tr);
  reindex();
  updateTotal();
}

/* reindex rows */
function reindex(){
  Array.from(tbody.children).forEach((tr,i)=> tr.querySelector('.numcol').textContent = i+1 );
  rowCountEl.textContent = tbody.children.length;
}

/* collect data for export */
function collectData(){
  const travel = {
    arrival: document.getElementById('arrival').value || '',
    return: document.getElementById('return').value || '',
    traveler: document.getElementById('traveler').value || ''
  };
  const receipts = Array.from(tbody.children).map((tr,i)=>({
    num: i+1,
    dateRaw: tr.querySelector('.r-date').value || '',
    date: tr.querySelector('.r-date').value ? formatDateDE(tr.querySelector('.r-date').value) : '',
    category: tr.querySelector('.r-cat').value || '',
    currency: tr.querySelector('.r-curr').value || 'EUR',
    exchangeRate: (function(v){ v = String(v||'').replace(',', '.'); const n = parseFloat(v); return isNaN(n)?0:n; })(tr.querySelector('.r-rate').value),
    cost: (function(v){ v = String(v||'').replace(',', '.'); const n = parseFloat(v); return isNaN(n)?0:n; })(tr.querySelector('.r-cost').value)
  }));
  return {travel, receipts};
}
function formatDateDE(value){
  if(!value) return '';
  const d = new Date(value);
  if (isNaN(d)) return value;
  const day = String(d.getDate()).padStart(2,'0');
  const month = String(d.getMonth()+1).padStart(2,'0');
  const year = d.getFullYear();
  return `${day}.${month}.${year}`;
}

/* CSV download (exchange rates formatted without trailing comma, costs with 2 decimals) */
function downloadCSV(){
  const {travel, receipts} = collectData();
  const header = [
    ['Arrival Date', travel.arrival],
    ['Return Date', travel.return],
    ['Traveler', travel.traveler],
    []
  ];
  const tableHeader = ['No','Date','Category','Currency','Exchange Rate','Cost in EUR'];
  const rowsCsv = receipts.map(r => [
    r.num,
    r.date,
    r.category,
    r.currency,
    (Number(r.exchangeRate) || 0).toString(), // ensure no trailing comma
    (Number(r.cost) || 0).toFixed(2)
  ]);
  const total = receipts.reduce((s,r)=>s + (Number(r.cost)||0), 0);
  rowsCsv.push(['','','','','Total', total.toFixed(2)]);
  const all = header.concat([tableHeader]).concat(rowsCsv);
  const csv = all.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `${weekFileName()}.csv`; document.body.appendChild(a); a.click(); a.remove();
}

/* XLSX download with formatting and targeted placement */
async function downloadXLSX(){
  if(!sheetjsAvailable){
    // prevent clicking if not available
    return;
  }
  if(typeof XLSX === 'undefined'){
    // try to load (shouldn't normally reach here because pre-check handled)
    try{
      await loadSheetJS();
    }catch(e){
      alert('SheetJS konnte nicht geladen werden.');
      return;
    }
  }

  const {travel, receipts} = collectData();

  // Prepare ws_data with enough rows to place labels at specific positions
  const arrivalRow = 6;
  const returnRow = 7;
  const travelerRow = 8;
  const tableHeaderRow = 10;
  const dataStartRow = tableHeaderRow + 1;
  const maxRows = dataStartRow + receipts.length + 3;
  const ws_data = Array.from({length: maxRows}, ()=>[]);

  // Place header row at A10..F10
  ws_data[tableHeaderRow - 1] = ['No','Date','Category','Currency','Exchange Rate','Cost in EUR'];

  // Fill receipts
  receipts.forEach((r, idx)=>{
    ws_data[dataStartRow - 1 + idx] = [r.num, r.dateRaw || r.date, r.category, r.currency, r.exchangeRate, r.cost];
  });

  // Total row
  const totalRowIndex = dataStartRow - 1 + receipts.length;
  ws_data[totalRowIndex] = ['','','','','Total', receipts.reduce((s,r)=>s + (Number(r.cost)||0), 0)];

  // Build worksheet
  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  // Column widths (A wider so labels fit)
  ws['!cols'] = [
    {wpx:70},  // No (also A holds labels)
    {wpx:120}, // Date
    {wpx:220}, // Category
    {wpx:100}, // Currency
    {wpx:110}, // Exchange Rate
    {wpx:120}  // Cost
  ];

  // Place Arrival/Return/Traveler at A6/B6 etc with proper types
  function setCellText(ref, text){ ws[ref] = { t:'s', v: String(text || '') }; }
  function setCellDate(ref, isoDate){
    if(!isoDate){ ws[ref] = { t:'s', v: '' }; return; }
    const d = new Date(isoDate);
    if(isNaN(d)) ws[ref] = { t:'s', v: isoDate };
    else ws[ref] = { t:'d', v: d, z:'dd.mm.yyyy' };
  }
  setCellText(`A${arrivalRow}`, 'Arrival Date');
  setCellDate(`B${arrivalRow}`, travel.arrival);

  setCellText(`A${returnRow}`, 'Return Date');
  setCellDate(`B${returnRow}`, travel.return);

  setCellText(`A${travelerRow}`, 'Traveler');
  setCellText(`B${travelerRow}`, travel.traveler);

  // Style header cells (attempt; some viewers may ignore .s)
  const headerCols = ['A','B','C','D','E','F'];
  headerCols.forEach(col=>{
    const ref = `${col}${tableHeaderRow}`;
    if(!ws[ref]) ws[ref] = { t:'s', v: '' };
    ws[ref].s = { font:{bold:true}, fill:{fgColor:{rgb:"FFE9ECEF"}}, alignment:{vertical:'center'} };
  });

  // Format each data row: Dates as date cells, cost numeric 2 decimals, exchange numeric up to 4 decimals
  receipts.forEach((r, idx)=>{
    const row = dataStartRow + idx;
    // Date
    if(r.dateRaw){
      const d = new Date(r.dateRaw);
      if(!isNaN(d)) ws[`B${row}`] = { t:'d', v: d, z:'dd.mm.yyyy' };
      else ws[`B${row}`] = { t:'s', v: r.date };
    } else ws[`B${row}`] = { t:'s', v: '' };

    // No
    ws[`A${row}`] = { t:'n', v: Number(r.num) || 0 };

    // Category, Currency
    ws[`C${row}`] = { t:'s', v: r.category || '' };
    ws[`D${row}`] = { t:'s', v: r.currency || '' };
    
    // Exchange rate numeric – always 3 decimals
    ws[`E${row}`] = {
      t: 'n',
      v: Number(r.exchangeRate) || 0,
      z: '0.000'
    };

    // Cost numeric 2 decimals
    ws[`F${row}`] = { t:'n', v: Number(r.cost) || 0, z: '0.00' };
  });

  // Total cell bold and numeric 2 decimals
  const totalExcelRow = totalRowIndex + 1; // ws_data index -> Excel row
  ws[`F${totalExcelRow}`] = { t:'n', v: receipts.reduce((s,r)=>s + (Number(r.cost)||0), 0), z:'0.00', s:{font:{bold:true}} };
  ws[`E${totalExcelRow}`] = { t:'s', v:'Total', s:{font:{bold:true}} };

  // Autofilter for the table region if receipts present
  const lastDataRow = dataStartRow + receipts.length - 1;
  if(receipts.length > 0){
    try{ ws['!autofilter'] = { ref: `A${tableHeaderRow}:F${lastDataRow}` }; }catch(e){}
  }

  // Compose workbook and download using week filename
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Travel Expenses');

  try{
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `${weekFileName()}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
  }catch(e){
    console.error(e);
    alert('Fehler beim Erstellen der Excel-Datei.');
  }
}

/* Preload SheetJS to detect blocked environments.
   If blocked, show red warning and disable Excel button.
   This runs on load and sets sheetjsAvailable flag.
*/
function loadSheetJS(timeout = 2500){
  return new Promise((resolve, reject) => {
    if(typeof XLSX !== 'undefined'){ sheetjsAvailable = true; resolve(true); return; }
    const s = document.createElement('script');
    let done = false;
    s.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
    s.async = true;
    s.onload = () => { if(done) return; done = true; sheetjsAvailable = true; resolve(true); };
    s.onerror = () => { if(done) return; done = true; sheetjsAvailable = false; reject(new Error('Script load failed')); };
    document.head.appendChild(s);
    // Timeout to detect content blocker silently blocking script
    setTimeout(()=>{ if(done) return; done = true; sheetjsAvailable = (typeof XLSX !== 'undefined'); if(sheetjsAvailable) resolve(true); else reject(new Error('Script load timeout/blocked')); }, timeout);
  });
}

/* run check on load */
async function checkSheetAvailability(){
  try{
    await loadSheetJS();
    // no warning, ensure button enabled
    exportWarning.style.display = 'none';
    btnXlsx.disabled = false;
  }catch(e){
    // show warning and disable excel button
    exportWarning.style.display = 'block';
    btnXlsx.disabled = true;
  }
}

/* Events */
document.getElementById('add-row').addEventListener('click', ()=> makeRow({}));
document.getElementById('remove-row').addEventListener('click', ()=>{
  if(!tbody.lastElementChild) return;
  rows.pop();
  tbody.lastElementChild.remove();
  reindex();
  updateTotal();
});
document.getElementById('clear-all').addEventListener('click', ()=>{
  if(!confirm('Delete all entries?')) return;
  rows = []; tbody.innerHTML = ''; reindex(); updateTotal();
});
document.getElementById('download-csv').addEventListener('click', downloadCSV);
document.getElementById('download-xlsx').addEventListener('click', downloadXLSX);

/* seed row */
makeRow();

/* Ensure totals update on cost input anywhere */
window.addEventListener('input', (e)=>{
  if(e.target && e.target.classList && e.target.classList.contains('r-cost')) updateTotal();
});

/* defensive style refresh for iOS */
window.addEventListener('load', ()=> {
  document.querySelectorAll('input,select,textarea').forEach(el=>el.style.backgroundClip='padding-box');
  checkSheetAvailability(); // check for content blocker / script blocking
});

/* Make Powered by Ovarna link open in new tab and mailto works via href already set */
document.getElementById('ovarna-link').addEventListener('click', (e)=> {
  // default behavior is ok; this is kept for clarity and future analytics hooks
});

/* Accessibility: format existing cost values to 2 decimals when page left/loaded (defensive) */
window.addEventListener('beforeunload', ()=> {
  Array.from(tbody.querySelectorAll('.r-cost')).forEach(i=>{
    const v = numericFromInput(i.value);
    if(i.value !== '') i.value = v.toFixed(2);
  });
});
</script>
</body>
</html>
